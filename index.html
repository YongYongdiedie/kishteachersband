<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KISH êµì‚¬ ë°´ë“œ í¬í„¸ v3</title>
  <style>
    :root{
      --bg:#0b0c10;--card:#13151a;--muted:#8a8f98;--text:#e7ecf3;--accent:#58a6ff;--accent-2:#7ee787;--danger:#ff6b6b;--border:#242834;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--accent)}
    .container{max-width:1100px;margin:0 auto;padding:24px}

    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{margin:0;font-size:clamp(22px,4vw,34px);font-weight:800;letter-spacing:-.3px}

    .btn{border:1px solid var(--border);background:#17202b;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;display:inline-flex;gap:8px;align-items:center}
    .btn:hover{transform:translateY(-1px);border-color:#2f3442}
    .btn.accent{background:var(--accent);border-color:transparent;color:#0b1220}
    .btn.ghost{background:transparent}
    .btn.danger{border-color:#4a1c1c;background:#2a1515;color:#ffb3b3}

    .tabs{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#111722;cursor:pointer}
    .tab.active{background:#17202b}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}

    .row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .rowHead{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .muted{color:var(--muted)}

    dialog{border:none;border-radius:16px;padding:0;max-width:980px;width:96vw;background:var(--card);color:var(--text);box-shadow:0 20px 60px rgba(0,0,0,.5);}
    .dlgHead{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--border)}
    .dlgBody{padding:16px}
    .dlgFoot{display:flex;justify-content:flex-end;gap:8px;padding:16px;border-top:1px solid var(--border)}

    /* Auth */
    .authWrap{max-width:560px;margin:40px auto}
    .tabsAuth{display:flex;gap:8px;margin-bottom:12px}
    .tabsAuth .tab{color:#fff;border-color:var(--border);opacity:.95}
    .tabsAuth .tab.active{outline:2px solid var(--accent);opacity:1}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{border:1px solid var(--border);background:#0f1117;color:#e7ecf3;padding:10px 12px;border-radius:10px}
    textarea{min-height:120px}

    /* Search bar */
    .subbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 16px}
    .search{display:flex;gap:8px;align-items:center;background:#111722;padding:10px 12px;border-radius:12px;border:1px solid var(--border);min-width:280px}
    .search input{all:unset;width:220px}
    .search select{background:transparent;border:1px solid var(--border);color:#e7ecf3;padding:6px 8px;border-radius:8px}
    .pill{font-size:12px;color:var(--muted)}

    /* Tables */
    table.parts, table.board, table.logs{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
    table.parts th, table.parts td, table.board th, table.board td, table.logs th, table.logs td{padding:10px 12px;text-align:left}
    table.parts th, table.board th, table.logs th{color:#c9d1d9;font-weight:700}
    table.parts tr, table.logs tr{background:#0f1117;border:1px solid var(--border)}
    table.parts tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    table.parts tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}

    .headBtns{display:flex;gap:8px;align-items:center}
    .empty{color:var(--muted);text-align:center;padding:40px;border:1px dashed var(--border);border-radius:12px;background:rgba(255,255,255,0.02)}

    /* Autocomplete */
    .autocomplete{position:relative}
    .ac-menu{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-top:6px;z-index:10;overflow:hidden}
    .ac-item{padding:10px 12px;cursor:pointer;border-top:1px solid var(--border)}
    .ac-item:first-child{border-top:none}
    .ac-item:hover{background:#1a1f2b}

    /* Comments */
    .comment{border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0;background:#0f1117}
    .commentHead{display:flex;justify-content:space-between;align-items:center}

    .miniDel{margin-left:8px;border:1px solid var(--border);background:#141922;color:var(--muted);padding:2px 6px;border-radius:8px;cursor:pointer;font-size:12px}
    .miniDel:hover{color:#fff}

    @media (max-width:760px){
      .rowHead{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸµ KISH êµì‚¬ ë°´ë“œ í¬í„¸ v3</h1>
      <div class="headBtns" id="userBar" style="display:none"></div>
    </header>

    <!-- AUTH SCREEN -->
    <section id="authScreen" class="authWrap">
      <div class="tabsAuth">
        <button class="tab active" id="tabLogin">ë¡œê·¸ì¸</button>
        <button class="tab" id="tabSignup">íšŒì›ê°€ì…</button>
      </div>
      <div id="loginPane" class="card">
        <div class="field"><label>ì´ë¦„</label><input id="loginName" type="text" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜"></div>
        <div class="field"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
        <button class="btn accent" id="loginBtn">ë¡œê·¸ì¸</button>
        <div class="muted" style="margin-top:10px">ê´€ë¦¬ì: <b>admin</b> / ë¹„ë°€ë²ˆí˜¸ <b>1111</b></div>
        <div class="muted" style="margin-top:10px; text-align:right">
          <button class="btn ghost" id="initBtn" title="ì €ì¥ëœ ë°ì´í„° ì´ˆê¸°í™”">í™˜ê²½ ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div id="signupPane" class="card" style="display:none">
        <div class="field"><label>ì´ë¦„</label><input id="suName" type="text" placeholder="ì‹¤ëª… ì…ë ¥"></div>
        <div class="field"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
        <div class="field"><label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="suPw2" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"></div>
        <div class="field"><label>ë¶€ì„œ</label><input id="suDept" type="text" placeholder="ì˜ˆ: ê³¼í•™ê³¼"></div>
        <div class="field"><label>ë‹´ë‹¹ íŒŒíŠ¸</label>
          <select id="suPart">
            <option value="ì¼ë ‰ê¸°íƒ€">ì¼ë ‰ê¸°íƒ€</option>
            <option value="ë² ì´ìŠ¤ê¸°íƒ€">ë² ì´ìŠ¤ê¸°íƒ€</option>
            <option value="ë³´ì»¬">ë³´ì»¬</option>
            <option value="í”¼ì•„ë…¸">í”¼ì•„ë…¸</option>
            <option value="ì‹ ë””ì‚¬ì´ì €">ì‹ ë””ì‚¬ì´ì €</option>
            <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
          </select>
        </div>
        <div class="field" id="suPartCustomWrap" style="display:none"><label>ë‹´ë‹¹ íŒŒíŠ¸(ì§ì ‘ì…ë ¥)</label><input id="suPartCustom" type="text" placeholder="ì˜ˆ: ìƒ‰ì†Œí°"></div>
        <button class="btn accent" id="signupBtn">íšŒì›ê°€ì… ìš”ì²­</button>
        <div class="muted" style="margin-top:10px">â€» ê´€ë¦¬ìê°€ ìŠ¹ì¸í•´ì•¼ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
      </div>
    </section>

    <!-- APP SCREEN -->
    <section id="appScreen" style="display:none">
      <div class="tabs" id="mainTabs">
        <button class="tab active" data-tab="playlist">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</button>
        <button class="tab" data-tab="board">ììœ ê²Œì‹œíŒ</button>
        <button class="tab" data-tab="admin" id="adminTab" style="display:none">ê´€ë¦¬ì</button>
      </div>

      <!-- PLAYLIST TAB -->
      <section id="tab-playlist">
        <div class="subbar">
          <div class="search" role="search">
            <select id="searchField" aria-label="ê²€ìƒ‰ í•„ë“œ">
              <option value="title">ì œëª©</option>
              <option value="artist">ê°€ìˆ˜</option>
            </select>
            <div class="autocomplete" style="flex:1">
              <input id="searchInput" type="text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ìë™ì™„ì„±)" aria-label="ê²€ìƒ‰" autocomplete="off" />
              <div id="acMenu" class="ac-menu" style="display:none"></div>
            </div>
            <button id="clearSearch" class="btn" title="ê²€ìƒ‰ ì§€ìš°ê¸°">ì§€ìš°ê¸°</button>
          </div>
          <span class="pill">ì •ë ¬: í•œê¸€ ììŒ ìˆœ (ì œëª©)</span>
          <div class="headBtns">
            <button id="byPersonBtn" class="btn" title="ë‹´ë‹¹ìë³„ ê³¡ ë° íŒŒíŠ¸ í™•ì¸">ë‹´ë‹¹ìë³„ ê³¡ ë° íŒŒíŠ¸ í™•ì¸</button>
            <button id="addBtn" class="btn accent" title="ê³¡ ì¶”ê°€">+ ê³¡ ì¶”ê°€</button>
          </div>
        </div>
        <div id="list" class="list"></div>
        <div id="empty" class="empty" style="display:none">ì•„ì§ ë“±ë¡ëœ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤. <b>+ ê³¡ ì¶”ê°€</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>
      </section>

      <!-- BOARD TAB -->
      <section id="tab-board" style="display:none">
        <div class="rowHead" style="margin-bottom:10px">
          <div style="font-weight:700">ììœ ê²Œì‹œíŒ</div>
          <button class="btn accent" id="postNewBtn">+ ê¸€ì“°ê¸°</button>
        </div>
        <div class="muted" style="margin-bottom:10px">ì§ˆë¬¸ì´ë‚˜ ê±´ì˜ì‚¬í•­ ë“± ììœ ë¡­ê²Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        <div class="card">
          <table class="board" id="boardTable" style="border-spacing:0">
            <thead>
              <tr><th style="width:70px">ìˆœë²ˆ</th><th>ì œëª©</th><th style="width:160px">ì‘ì„±ì</th><th style="width:200px">ì‘ì„±ì¼</th><th style="width:220px">ê´€ë¦¬</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="boardEmpty" class="empty" style="display:none">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </section>

      <!-- ADMIN TAB -->
      <section id="tab-admin" style="display:none">
        <div class="rowHead" style="margin-bottom:10px">
          <div style="font-weight:700">ê°€ì… ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡</div>
        </div>
        <div class="card">
          <table class="board" id="signupTable" style="border-spacing:0">
            <thead>
              <tr><th>ì´ë¦„</th><th>ë¶€ì„œ</th><th>ë‹´ë‹¹ íŒŒíŠ¸</th><th>ì‹ ì²­ì¼</th><th style="width:220px">ìŠ¹ì¸/ê±°ì ˆ</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="signupEmpty" class="empty" style="display:none">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <div style="height:16px"></div>
        <div class="rowHead" style="margin-bottom:10px">
          <div style="font-weight:700">ì‚¬ìš©ì ê´€ë¦¬</div>
          <button class="btn" id="userAddBtn">+ ì‚¬ìš©ì ì¶”ê°€</button>
        </div>
        <div class="card">
          <table class="board" id="usersTable" style="border-spacing:0">
            <thead>
              <tr><th>ì´ë¦„</th><th>ë¶€ì„œ</th><th>ë‹´ë‹¹ íŒŒíŠ¸</th><th>ê°€ì…ì¼</th><th style="width:320px">ê´€ë¦¬</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="usersEmpty" class="empty" style="display:none">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <div style="height:16px"></div>
        <div class="rowHead" style="margin-bottom:10px">
          <div style="font-weight:700">ê´€ë¦¬ì ë¡œê·¸</div>
          <div class="headBtns">
            <button id="logsExportBtn" class="btn">ë‚´ë³´ë‚´ê¸°</button>
            <button id="logsClearBtn" class="btn danger">ëª¨ë‘ ë¹„ìš°ê¸°</button>
          </div>
        </div>
        <div class="card">
          <table class="logs" id="logsTable">
            <thead>
              <tr><th style="width:180px">ì‹œê°„</th><th style="width:120px">ê´€ë¦¬ì</th><th style="width:160px">ë™ì‘</th><th>ìƒì„¸</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="logsEmpty" class="empty" style="display:none">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </section>
    </section>
  </div>

  <!-- SONG DIALOG (Add/Edit) -->
  <dialog id="songDlg">
    <form id="songForm" method="dialog">
      <div class="dlgHead">
        <div style="font-weight:800">ê³¡ ì •ë³´ ì…ë ¥</div>
        <button id="closeDlg" class="btn" value="cancel" type="button">ë‹«ê¸°</button>
      </div>
      <div class="dlgBody">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="field"><label for="title">ì œëª©*</label><input id="title" name="title" type="text" required /></div>
          <div class="field"><label for="artist">ê°€ìˆ˜*</label><input id="artist" name="artist" type="text" required /></div>
          <div class="field"><label for="version">ë²„ì „</label><input id="version" name="version" type="text" placeholder="ì˜ˆ: ì›ê³¡/ì–´ì¿ /ë½ver." /></div>
        </div>

        <div class="partsEditor" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 6px">
            <label style="display:block;color:#c9d1d9;font-weight:700">íŒŒíŠ¸ë³„ ë‹´ë‹¹ì/ë§í¬/ê³µìœ </label>
            <button id="addPartBtn" type="button" class="btn" title="íŒŒíŠ¸ ì¶”ê°€">+ íŒŒíŠ¸ ì¶”ê°€</button>
          </div>
          <table class="parts">
            <thead>
              <tr>
                <th style="width:180px">íŒŒíŠ¸</th>
                <th style="width:28%">ë‹´ë‹¹ì</th>
                <th>ì˜ˆì‹œ ë§í¬(ìœ íŠœë¸Œ ë“±)</th>
                <th>ê¸°íƒ€/ê³µìœ (ë“œë¼ì´ë¸Œ ë“±)</th>
              </tr>
            </thead>
            <tbody id="partsTbody"></tbody>
          </table>
        </div>
      </div>
      <div class="dlgFoot">
        <button class="btn" value="cancel" type="button" id="cancelBtn">ì·¨ì†Œ</button>
        <button class="btn accent" id="saveBtn" type="submit">ì™„ë£Œ</button>
      </div>
    </form>
  </dialog>

  <!-- BY PERSON DIALOG -->
  <dialog id="personDlg">
    <div class="dlgHead">
      <div style="font-weight:800">ë‹´ë‹¹ìë³„ ê³¡ ë° íŒŒíŠ¸ í™•ì¸</div>
      <button id="closePersonDlg" class="btn" type="button">ë‹«ê¸°</button>
    </div>
    <div class="dlgBody">
      <div class="search" role="search">
        <div class="autocomplete" style="flex:1">
          <input id="personInput" type="text" placeholder="ì´ë¦„ ì…ë ¥ (ìë™ì™„ì„±)" autocomplete="off" />
          <div id="personAcMenu" class="ac-menu" style="display:none"></div>
        </div>
        <button id="personClear" class="btn" title="ê²€ìƒ‰ ì§€ìš°ê¸°">ì§€ìš°ê¸°</button>
      </div>
      <div style="margin-top:12px">
        <table class="parts" id="personTable">
          <thead>
            <tr><th>ê³¡</th><th>ê°€ìˆ˜</th><th>ë²„ì „</th><th>ë‹´ë‹¹ íŒŒíŠ¸</th><th>ì˜ˆì‹œ ë§í¬</th><th>ê³µìœ  ë§í¬</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="personEmpty" class="empty" style="display:none">ë‹´ë‹¹ëœ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </dialog>

  <!-- BOARD DIALOGS -->
  <dialog id="postDlg">
    <form id="postForm" method="dialog">
      <div class="dlgHead">
        <div style="font-weight:800" id="postDlgTitle">ê¸€ì“°ê¸°</div>
        <button id="closePostDlg" class="btn" value="cancel" type="button">ë‹«ê¸°</button>
      </div>
      <div class="dlgBody">
        <div class="field"><label>ì œëª©</label><input id="postTitle" type="text" placeholder="ì œëª© ì…ë ¥"></div>
        <div class="field"><label>ë‚´ìš©</label><textarea id="postBody" placeholder="ë‚´ìš© ì…ë ¥"></textarea></div>
      </div>
      <div class="dlgFoot">
        <button class="btn" value="cancel" type="button" id="cancelPostBtn">ì·¨ì†Œ</button>
        <button class="btn accent" id="savePostBtn" type="submit">ì™„ë£Œ</button>
      </div>
    </form>
  </dialog>

  <dialog id="postViewDlg">
    <div class="dlgHead">
      <div style="font-weight:800" id="postViewTitle">ê¸€ ì œëª©</div>
      <button id="closePostViewDlg" class="btn" type="button">ë‹«ê¸°</button>
    </div>
    <div class="dlgBody">
      <div class="muted" id="postMeta">ì‘ì„±ì Â· ë‚ ì§œ</div>
      <div id="postViewBody" class="card" style="white-space:pre-wrap;margin-top:8px"></div>
      <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">ëŒ“ê¸€</div>
        <div id="postViewActions"></div>
      </div>
      <div id="commentsWrap"></div>
      <div id="commentEditor" class="card" style="margin-top:8px">
        <div class="field"><label>ëŒ“ê¸€ ë‚´ìš©</label><textarea id="commentBody" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea></div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="cancelCommentBtn" type="button">ì§€ìš°ê¸°</button>
          <button class="btn accent" id="addCommentBtn" type="button">ëŒ“ê¸€ ë“±ë¡</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- USER DIALOG (Admin add/edit) -->
  <dialog id="userDlg">
    <form id="userForm" method="dialog">
      <div class="dlgHead">
        <div style="font-weight:800" id="userDlgTitle">ì‚¬ìš©ì ì¶”ê°€</div>
        <button id="closeUserDlg" class="btn" type="button">ë‹«ê¸°</button>
      </div>
      <div class="dlgBody">
        <div class="field"><label>ì´ë¦„</label><input id="udName" type="text" placeholder="ì´ë¦„"></div>
        <div class="field"><label>ë¹„ë°€ë²ˆí˜¸ <span class="muted" id="udPwHint">(ìƒˆ ì‚¬ìš©ì: í•„ìˆ˜ / ìˆ˜ì • ì‹œ ë¹„ì›Œë‘ë©´ ìœ ì§€)</span></label><input id="udPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
        <div class="field"><label>ë¶€ì„œ</label><input id="udDept" type="text" placeholder="ë¶€ì„œ"></div>
        <div class="field"><label>ë‹´ë‹¹ íŒŒíŠ¸</label>
          <select id="udPart">
            <option value="ì¼ë ‰ê¸°íƒ€">ì¼ë ‰ê¸°íƒ€</option>
            <option value="ë² ì´ìŠ¤ê¸°íƒ€">ë² ì´ìŠ¤ê¸°íƒ€</option>
            <option value="ë³´ì»¬">ë³´ì»¬</option>
            <option value="í”¼ì•„ë…¸">í”¼ì•„ë…¸</option>
            <option value="ì‹ ë””ì‚¬ì´ì €">ì‹ ë””ì‚¬ì´ì €</option>
            <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
          </select>
        </div>
        <div class="field" id="udPartCustomWrap" style="display:none"><label>ë‹´ë‹¹ íŒŒíŠ¸(ì§ì ‘ì…ë ¥)</label><input id="udPartCustom" type="text" placeholder="ì˜ˆ: ìƒ‰ì†Œí°"></div>
      </div>
      <div class="dlgFoot">
        <button class="btn" id="cancelUserBtn" type="button">ì·¨ì†Œ</button>
        <button class="btn accent" id="saveUserBtn" type="submit">ì €ì¥</button>
      </div>
    </form>
  </dialog>

  <!-- PROFILE DIALOG -->
  <dialog id="profileDlg">
    <form id="profileForm" method="dialog">
      <div class="dlgHead">
        <div style="font-weight:800">ë‚´ ì •ë³´</div>
        <button id="closeProfileDlg" class="btn" type="button">ë‹«ê¸°</button>
      </div>
      <div class="dlgBody">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="field"><label>ì´ë¦„</label><input id="pfName" type="text" placeholder="ì´ë¦„"></div>
          <div class="field"><label>ë¶€ì„œ</label><input id="pfDept" type="text" placeholder="ë¶€ì„œ"></div>
          <div class="field"><label>ë‹´ë‹¹ íŒŒíŠ¸</label>
            <select id="pfPart">
              <option value="ì¼ë ‰ê¸°íƒ€">ì¼ë ‰ê¸°íƒ€</option>
              <option value="ë² ì´ìŠ¤ê¸°íƒ€">ë² ì´ìŠ¤ê¸°íƒ€</option>
              <option value="ë³´ì»¬">ë³´ì»¬</option>
              <option value="í”¼ì•„ë…¸">í”¼ì•„ë…¸</option>
              <option value="ì‹ ë””ì‚¬ì´ì €">ì‹ ë””ì‚¬ì´ì €</option>
              <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
            </select>
          </div>
          <div class="field" id="pfPartCustomWrap" style="display:none"><label>ë‹´ë‹¹ íŒŒíŠ¸(ì§ì ‘ì…ë ¥)</label><input id="pfPartCustom" type="text" placeholder="ì˜ˆ: ìƒ‰ì†Œí°"></div>
        </div>
        <div class="card" style="margin-top:12px">
          <div class="field"><label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ <span class="muted" id="pfPwHint">(ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)</span></label><input id="pfCurPw" type="password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"></div>
          <div class="field"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input id="pfNewPw" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"></div>
          <div class="field"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="pfNewPw2" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸"></div>
        </div>
      </div>
      <div class="dlgFoot">
        <button class="btn" type="button" onclick="document.getElementById('profileDlg').close()">ì·¨ì†Œ</button>
        <button class="btn accent" id="profileSaveBtn" type="submit">ì €ì¥</button>
      </div>
    </form>
  </dialog>

  <script>
    // ====== Storage Keys ======
    const LS_SONGS = 'kish_band_playlist_v1';
    const LS_USERS = 'kish_users_v1';
    const LS_SIGNUPS = 'kish_signups_v1';
    const LS_POSTS = 'kish_board_posts_v1';
    const LS_SESSION = 'kish_session_v1';
    const LS_LOGS = 'kish_admin_logs_v1';

    const collator = new Intl.Collator('ko', { sensitivity: 'base', numeric: true });

    // ====== Utils ======
    const uid = ()=>'id-'+Math.random().toString(36).slice(2)+Date.now().toString(36);
    const fmtDate = (d)=>{
      const pad = n=> String(n).padStart(2,'0');
      const dt = new Date(d);
      return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    };
    async function hashHex(text){
      try{
        if(window.crypto && window.crypto.subtle){
          const buf = new TextEncoder().encode(text);
          const digest = await crypto.subtle.digest('SHA-256', buf);
          return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
      }catch(e){ /* fall through */ }
      // Fallback hash (DJB2) for non-secure contexts (e.g., file://)
      let h = 5381; for(let i=0;i<text.length;i++){ h=((h<<5)+h)+text.charCodeAt(i); h|=0; }
      return 'x'+(h>>>0).toString(16);
    };

    const read = (k, def)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch(e){ return def; } };
    const write = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

    // ====== Auth State ======
    let session = read(LS_SESSION, null); // {name}

    // ====== Users & Signups ======
    let users = read(LS_USERS, []);      // [{id,name,hash,dept,part,partCustom,createdAt}]
    let signups = read(LS_SIGNUPS, []);  // same shape but pending list
    let logs = read(LS_LOGS, []);        // [{id,ts,actor,action,meta}]

    function addLog(action, meta={}){
      logs.unshift({ id: uid(), ts: Date.now(), actor: session?.name || 'system', action, meta });
      if(logs.length>500) logs = logs.slice(0,500);
      write(LS_LOGS, logs);
      // refresh if admin tab visible
      if(document.getElementById('tab-admin').style.display!=='none' && document.querySelector('#tab-admin').style.display!=='none'){
        renderLogs();
      }
    }

    // ensure admin exists (no signup needed)
    (function ensureAdmin(){
      if(!users.some(u=>u.name==='admin')){
        users.push({ id: uid(), name:'admin', hash:'admin:1111', dept:'ê´€ë¦¬ì', part:'ê´€ë¦¬ì', partCustom:'', createdAt: Date.now() });
        write(LS_USERS, users);
        addLog('bootstrap_admin', {name:'admin'});
      }
    })();

    // ====== DOM Refs ======
    const authScreen = document.getElementById('authScreen');
    const appScreen = document.getElementById('appScreen');
    const userBar = document.getElementById('userBar');

    const tabLogin = document.getElementById('tabLogin');
    const tabSignup = document.getElementById('tabSignup');
    const loginPane = document.getElementById('loginPane');
    const signupPane = document.getElementById('signupPane');

    const loginName = document.getElementById('loginName');
    const loginPw = document.getElementById('loginPw');
    const loginBtn = document.getElementById('loginBtn');

    const suName = document.getElementById('suName');
    const suPw = document.getElementById('suPw');
    const suPw2 = document.getElementById('suPw2');
    const suDept = document.getElementById('suDept');
    const suPart = document.getElementById('suPart');
    const suPartCustomWrap = document.getElementById('suPartCustomWrap');
    const suPartCustom = document.getElementById('suPartCustom');
    const signupBtn = document.getElementById('signupBtn');

    const mainTabs = document.getElementById('mainTabs');
    const adminTab = document.getElementById('adminTab');

    // ====== SONGS (Playlist) ======
    const DEFAULT_PARTS = [
      { key:'1stKeys',  label:'1st ê±´ë°˜', builtin:true },
      { key:'2ndKeys',  label:'2nd ê±´ë°˜', builtin:true },
      { key:'1stElec',  label:'1st ì¼ë ‰', builtin:true },
      { key:'2ndElec',  label:'2nd ì¼ë ‰', builtin:true },
      { key:'Acoustic', label:'ì–´ì¿ ìŠ¤í‹± ê¸°íƒ€', builtin:true },
      { key:'Bass',     label:'ë² ì´ìŠ¤ ê¸°íƒ€', builtin:true },
      { key:'Drums',    label:'ë“œëŸ¼', builtin:true },
      { key:'Vocal1',   label:'ë³´ì»¬ 1', builtin:true },
      { key:'Vocal2',   label:'ë³´ì»¬ 2', builtin:true },
      { key:'Vocal3',   label:'ë³´ì»¬ 3', builtin:true },
    ];
    const slugify = (s)=> s.toString().trim().replace(/\s+/g,'-').replace(/[^\w\-ê°€-í£]/g,'').replace(/\-+/g,'-').toLowerCase() || ('p-'+Math.random().toString(36).slice(2,7));
    const uniqueKey = (base, used)=>{ let k = base; let i=2; while(used.has(k)) k = base+"-"+(i++); return k; };
    const cloneDefaults = ()=> DEFAULT_PARTS.map(p=> ({ key:p.key, label:p.label, player:'', ref:'', misc:'', builtin:true }));
    function normalizeSong(s){
      if(Array.isArray(s.parts)){
        s.parts = s.parts.map(p=> ({ key: p.key || slugify(p.label||'part'), label: p.label || p.key || 'íŒŒíŠ¸', player: p.player || '', ref: p.ref || '', misc: p.misc || '', builtin: !!p.builtin && DEFAULT_PARTS.some(d=>d.key===p.key) }));
        return s;
      }
      const arr = []; const obj = s.parts || {}; const used = new Set();
      DEFAULT_PARTS.forEach(d=>{ const pr = obj[d.key] || {player:'',ref:'',misc:''}; arr.push({ key:d.key, label:d.label, player:pr.player||'', ref:pr.ref||'', misc:pr.misc||'', builtin:true }); used.add(d.key); });
      Object.keys(obj).forEach(k=>{ if(!used.has(k)){ const pr = obj[k] || {player:'',ref:'',misc:''}; arr.push({ key:k, label:k, player:pr.player||'', ref:pr.ref||'', misc:pr.misc||'', builtin:false }); } });
      s.parts = arr; return s;
    }

    let songs = (read(LS_SONGS, []).map(normalizeSong));
    const saveSongs = ()=> write(LS_SONGS, songs);

    // Playlist DOM
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const addBtn = document.getElementById('addBtn');

    const songDlg = document.getElementById('songDlg');
    const songForm = document.getElementById('songForm');
    const closeDlg = document.getElementById('closeDlg');
    const cancelBtn = document.getElementById('cancelBtn');

    const titleInput = document.getElementById('title');
    const artistInput = document.getElementById('artist');
    const versionInput = document.getElementById('version');
    const partsTbody = document.getElementById('partsTbody');
    const addPartBtn = document.getElementById('addPartBtn');

    const searchField = document.getElementById('searchField');
    const searchInput = document.getElementById('searchInput');
    const acMenu = document.getElementById('acMenu');
    const clearSearch = document.getElementById('clearSearch');

    // By person dialog DOM
    const byPersonBtn = document.getElementById('byPersonBtn');
    const personDlg = document.getElementById('personDlg');
    const closePersonDlg = document.getElementById('closePersonDlg');
    const personInput = document.getElementById('personInput');
    const personAcMenu = document.getElementById('personAcMenu');
    const personClear = document.getElementById('personClear');
    const personTableBody = document.querySelector('#personTable tbody');
    const personEmpty = document.getElementById('personEmpty');
    const personColumns = ['title','artist','version','part','ref','misc'];
    let personSort = { key: 'title', dir: 'asc' };
    const personThead = document.querySelector('#personTable thead');

    function updatePersonHeader(){
      const labels = ['ê³¡','ê°€ìˆ˜','ë²„ì „','ë‹´ë‹¹ íŒŒíŠ¸','ì˜ˆì‹œ ë§í¬','ê³µìœ  ë§í¬'];
      const ths = personThead.querySelectorAll('th');
      ths.forEach((th,i)=>{
        const k = personColumns[i];
        let label = labels[i];
        if(k===personSort.key){ label += personSort.dir==='asc' ? ' â–²' : ' â–¼'; }
        th.textContent = label;
      });
    }
    personThead.addEventListener('click', (e)=>{
      const th = e.target.closest('th');
      if(!th) return;
      const idx = Array.from(personThead.querySelector('tr').children).indexOf(th);
      const key = personColumns[idx];
      if(!key) return;
      if(personSort.key===key){ personSort.dir = personSort.dir==='asc' ? 'desc' : 'asc'; }
      else { personSort.key = key; personSort.dir = 'asc'; }
      updatePersonHeader();
      renderPersonResults(personInput.value.trim());
    });

    // auth bar render
    function renderUserBar(){
      if(!session){ userBar.style.display='none'; return; }
      userBar.style.display='flex';
      userBar.innerHTML = '';
      const span = document.createElement('div');
      span.className='muted';
      span.textContent = `${session.name}ë‹˜`;
      const profile = document.createElement('button');
      profile.className='btn';
      profile.textContent='ë‚´ ì •ë³´';
      profile.addEventListener('click', openProfile);
      const logout = document.createElement('button');
      logout.className='btn ghost';
      logout.textContent = 'ë¡œê·¸ì•„ì›ƒ';
      logout.addEventListener('click', ()=>{ session=null; localStorage.removeItem(LS_SESSION); location.reload(); });
      userBar.appendChild(span); userBar.appendChild(profile); userBar.appendChild(logout);
    }
      userBar.style.display='flex';
      userBar.innerHTML = '';
      const span = document.createElement('div');
      span.className='muted';
      span.textContent = `${session.name}ë‹˜`; 
      const logout = document.createElement('button');
      logout.className='btn ghost';
      logout.textContent = 'ë¡œê·¸ì•„ì›ƒ';
      logout.addEventListener('click', ()=>{ session=null; localStorage.removeItem(LS_SESSION); location.reload(); });
      userBar.appendChild(span); userBar.appendChild(logout);
    }

    // ====== Playlist Rendering ======
    function renderSongs(){
      // filter & sort
      const q = searchInput.value.trim().toLowerCase();
      const field = searchField.value;
      const filtered = songs
        .slice()
        .sort((a,b)=> collator.compare(a.title||'', b.title||''))
        .filter(s=> { if(!q) return true; const t=(s[field]||'').toLowerCase(); return t.includes(q); });

      listEl.innerHTML='';
      if(filtered.length===0){ emptyEl.style.display='block'; return; }
      emptyEl.style.display='none';

      filtered.forEach((s, idx)=>{
        const row = document.createElement('div'); row.className='row';
        const head = document.createElement('div'); head.className='rowHead';

        const tl = document.createElement('div');
        tl.innerHTML = `<b>${idx+1}. ${s.title}</b> <span class="muted"> Â· ${s.artist}${s.version? ' Â· '+s.version:''}</span>`;
        const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='6px';
        const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='í¸ì§‘'; editBtn.addEventListener('click', ()=> openEditSong(s.id));
        const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='ì‚­ì œ'; delBtn.addEventListener('click', ()=> deleteSong(s.id));
        btns.appendChild(editBtn); btns.appendChild(delBtn);
        head.appendChild(tl); head.appendChild(btns);

        const det = document.createElement('details');
        const sum = document.createElement('summary'); sum.textContent = 'ìì„¸íˆ ë³´ê¸°'; det.appendChild(sum);
        const tbl = document.createElement('table'); tbl.className='parts';
        tbl.innerHTML = `<thead><tr><th>íŒŒíŠ¸</th><th>ë‹´ë‹¹ì</th><th>ì˜ˆì‹œ ë§í¬</th><th>ê¸°íƒ€/ê³µìœ </th></tr></thead>`;
        const tb = document.createElement('tbody');
        (s.parts||[]).forEach(p=>{
          const linkA = p.ref ? `<a href="${p.ref}" target="_blank" rel="noopener">ì—´ê¸°</a>` : '<span class="muted">-</span>';
          const linkB = p.misc ? `<a href="${p.misc}" target="_blank" rel="noopener">ì—´ê¸°</a>` : '<span class="muted">-</span>';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.label}</td><td>${p.player||'<span class=\"muted\">(ë¯¸ì •)</span>'}</td><td>${linkA}</td><td>${linkB}</td>`;
          tb.appendChild(tr);
        });
        tbl.appendChild(tb); det.appendChild(tbl);

        row.appendChild(head); row.appendChild(det);
        listEl.appendChild(row);
      });
    }

    // ====== Song Editor ======
    let editingSongId = null;
    let editingParts = [];
    function buildPartsEditor(){
      partsTbody.innerHTML='';
      editingParts.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span>${p.label}</span>${p.builtin? '': `<button type="button" class="miniDel" data-key="${p.key}">ì‚­ì œ</button>`}</td>
          <td><input type="text" data-key="${p.key}" data-field="player" placeholder="ë‹´ë‹¹ì ì´ë¦„" value="${p.player||''}"></td>
          <td><input type="url" data-key="${p.key}" data-field="ref" placeholder="ì˜ˆì‹œ ë§í¬ (https://)" value="${p.ref||''}"></td>
          <td><input type="url" data-key="${p.key}" data-field="misc" placeholder="ê¸°íƒ€/ê³µìœ  ë§í¬ (https://)" value="${p.misc||''}"></td>`;
        partsTbody.appendChild(tr);
      });
    }

    function openAddSong(){
      editingSongId = null;
      titleInput.value=''; artistInput.value=''; versionInput.value='';
      editingParts = cloneDefaults();
      buildPartsEditor();
      songDlg.showModal(); setTimeout(()=> titleInput.focus(), 50);
    }
    function openEditSong(id){
      const s = songs.find(x=>x.id===id); if(!s) return;
      editingSongId = id;
      titleInput.value = s.title||''; artistInput.value=s.artist||''; versionInput.value=s.version||'';
      editingParts = (s.parts||[]).map(p=>({...p}));
      buildPartsEditor(); songDlg.showModal(); setTimeout(()=> titleInput.focus(), 50);
    }
    function gatherParts(){
      const map = new Map(editingParts.map(p=>[p.key,p]));
      partsTbody.querySelectorAll('input').forEach(inp=>{ const k=inp.dataset.key; const f=inp.dataset.field; if(k&&f&&map.has(k)){ map.get(k)[f] = inp.value.trim(); }});
      return Array.from(map.values());
    }

    function deleteSong(id){
      const s = songs.find(x=>x.id===id); if(!s) return;
      if(!confirm('ì´ ê³¡ì„ ì‚­ì œí• ê¹Œìš”?')) return;
      songs = songs.filter(x=>x.id!==id); saveSongs(); renderSongs();
      addLog('song_deleted', {title:s.title, artist:s.artist});
    }

    addPartBtn.addEventListener('click', ()=>{
      const name = prompt('ì¶”ê°€í•  íŒŒíŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!name) return;
      const base = slugify(name); const used = new Set(editingParts.map(p=>p.key)); const key = uniqueKey(base, used);
      editingParts.push({ key, label:name.trim(), player:'', ref:'', misc:'', builtin:false }); buildPartsEditor();
    });
    partsTbody.addEventListener('click', (e)=>{ const btn=e.target.closest('.miniDel'); if(!btn) return; const key=btn.dataset.key; const idx=editingParts.findIndex(p=>p.key===key); if(idx>-1){ if(editingParts[idx].builtin){ alert('ê¸°ë³¸ íŒŒíŠ¸ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return;} editingParts.splice(idx,1); buildPartsEditor(); }});

    songForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const title = titleInput.value.trim(); const artist = artistInput.value.trim(); const version = versionInput.value.trim(); if(!title||!artist){ alert('ì œëª©ê³¼ ê°€ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
      const parts = gatherParts();
      if(editingSongId){ songs = songs.map(s=> s.id===editingSongId ? { ...s, title, artist, version, parts } : s); addLog('song_edited', {title, artist}); }
      else { songs.push({ id: uid(), title, artist, version, parts }); addLog('song_added', {title, artist}); }
      saveSongs(); songDlg.close(); renderSongs();
    });
    [closeDlg, cancelBtn].forEach(b=> b.addEventListener('click', ()=> songDlg.close()));
    addBtn.addEventListener('click', openAddSong);

    // ====== Search & Autocomplete (Songs) ======
    let acTimer=null;
    function updateAutocomplete(){
      const q = searchInput.value.trim().toLowerCase(); const field = searchField.value; if(!q){ acMenu.style.display='none'; acMenu.innerHTML=''; renderSongs(); return; }
      const candidates = songs.map(s=> s[field]||'').filter(Boolean).filter((v,i,arr)=> arr.indexOf(v)===i).filter(v=> v.toLowerCase().includes(q)).sort((a,b)=> collator.compare(a,b)).slice(0,8);
      if(candidates.length===0){ acMenu.style.display='none'; acMenu.innerHTML=''; renderSongs(); return; }
      acMenu.innerHTML = candidates.map(v=> `<div class="ac-item" data-value="${v.replaceAll('"','&quot;')}">${v}</div>`).join('');
      acMenu.style.display='block';
    }
    searchInput.addEventListener('input', ()=>{ clearTimeout(acTimer); acTimer=setTimeout(()=>{ updateAutocomplete(); renderSongs(); }, 200); });
    searchField.addEventListener('change', ()=>{ updateAutocomplete(); renderSongs(); });
    acMenu.addEventListener('click', (e)=>{ const item=e.target.closest('.ac-item'); if(!item) return; searchInput.value=item.dataset.value||''; acMenu.style.display='none'; renderSongs(); });
    document.addEventListener('click', (e)=>{ if(!acMenu.contains(e.target) && e.target!==searchInput){ acMenu.style.display='none'; }});
    clearSearch.addEventListener('click', ()=>{ searchInput.value=''; acMenu.style.display='none'; renderSongs(); });

    // ====== By Person (partial match + clickable sort) ======
    function getAllPlayers(){
      const names = [];
      songs.forEach(s=>{ (s.parts||[]).forEach(p=>{ const val=(p.player||'').trim(); if(!val) return; val.split(/[,/&]+/).map(x=>x.trim()).filter(Boolean).forEach(n=> names.push(n)); }); });
      return Array.from(new Set(names)).sort((a,b)=> collator.compare(a,b));
    }
    function renderPersonResults(name){
      personTableBody.innerHTML='';
      if(!name){ personEmpty.style.display='block'; return; }
      const needle = name.toLowerCase(); const rows=[];
      songs.forEach(s=>{ (s.parts||[]).forEach(p=>{ const txt=(p.player||'').trim(); if(!txt) return; const tokens = txt.split(/[,/&]+/).map(x=>x.trim()).filter(Boolean); const match = tokens.some(t=> t.toLowerCase().includes(needle)); if(match){ rows.push({ title:s.title, artist:s.artist, version:s.version||'', part:p.label, ref:p.ref||'', misc:p.misc||'' }); } }); });
      rows.sort((a,b)=>{ const k=personSort.key; const dir = personSort.dir==='asc'?1:-1; return dir*collator.compare((a[k]||''),(b[k]||'')); });
      if(rows.length===0){ personEmpty.style.display='block'; return; }
      personEmpty.style.display='none';
      rows.forEach(r=>{ const tr=document.createElement('tr'); const linkA=r.ref?`<a href="${r.ref}" target="_blank" rel="noopener">ì—´ê¸°</a>`:'<span class="muted">-</span>'; const linkB=r.misc?`<a href="${r.misc}" target="_blank" rel="noopener">ì—´ê¸°</a>`:'<span class="muted">-</span>'; tr.innerHTML = `<td>${r.title}</td><td>${r.artist}</td><td>${r.version}</td><td>${r.part}</td><td>${linkA}</td><td>${linkB}</td>`; personTableBody.appendChild(tr); });
    }
    function openPersonDlg(){ personInput.value=''; personAcMenu.style.display='none'; renderPersonResults(''); updatePersonHeader(); personDlg.showModal(); setTimeout(()=> personInput.focus(), 50); }
    byPersonBtn.addEventListener('click', openPersonDlg);
    closePersonDlg.addEventListener('click', ()=> personDlg.close());
    personInput.addEventListener('input', ()=>{ const q=personInput.value.trim().toLowerCase(); const all=getAllPlayers(); let cand=all; if(q) cand=all.filter(n=> n.toLowerCase().includes(q)); cand=cand.slice(0,8); if(cand.length===0){ personAcMenu.style.display='none'; personAcMenu.innerHTML=''; return; } personAcMenu.innerHTML = cand.map(v=> `<div class=\"ac-item\" data-value=\"${v.replaceAll('"','&quot;')}\">${v}</div>`).join(''); personAcMenu.style.display='block'; });
    personAcMenu.addEventListener('click', (e)=>{ const item=e.target.closest('.ac-item'); if(!item) return; personInput.value=item.dataset.value||''; personAcMenu.style.display='none'; renderPersonResults(personInput.value.trim()); });
    personClear.addEventListener('click', ()=>{ personInput.value=''; personAcMenu.style.display='none'; renderPersonResults(''); });
    document.addEventListener('click', (e)=>{ if(personDlg.open && !personAcMenu.contains(e.target) && e.target!==personInput){ personAcMenu.style.display='none'; } });

    // ====== BOARD ======
    let posts = read(LS_POSTS, []); // {id,title,body,author,createdAt,updatedAt,comments?}
    posts = posts.map(p=> ({ ...p, comments: Array.isArray(p.comments) ? p.comments : [] }));
    write(LS_POSTS, posts);

    const boardTableBody = document.querySelector('#boardTable tbody');
    const boardEmpty = document.getElementById('boardEmpty');
    const postNewBtn = document.getElementById('postNewBtn');

    const postDlg = document.getElementById('postDlg');
    const postForm = document.getElementById('postForm');
    const postDlgTitle = document.getElementById('postDlgTitle');
    const closePostDlg = document.getElementById('closePostDlg');
    const cancelPostBtn = document.getElementById('cancelPostBtn');
    const postTitle = document.getElementById('postTitle');
    const postBody = document.getElementById('postBody');

    const postViewDlg = document.getElementById('postViewDlg');
    const postViewTitle = document.getElementById('postViewTitle');
    const postMeta = document.getElementById('postMeta');
    const postViewBody = document.getElementById('postViewBody');
    const postViewActions = document.getElementById('postViewActions');
    const commentsWrap = document.getElementById('commentsWrap');
    const commentBody = document.getElementById('commentBody');
    const addCommentBtn = document.getElementById('addCommentBtn');
    const cancelCommentBtn = document.getElementById('cancelCommentBtn');
    const closePostViewDlg = document.getElementById('closePostViewDlg');

    let editingPostId = null;
    let viewingPostId = null;

    function renderBoard(){
      const rows = posts.slice().sort((a,b)=> b.createdAt - a.createdAt);
      boardTableBody.innerHTML='';
      if(rows.length===0){ boardEmpty.style.display='block'; return; }
      boardEmpty.style.display='none';
      rows.forEach((p,idx)=>{
        const tr=document.createElement('tr');
        const canEdit = session && (session.name==='admin' || session.name===p.author);
        const titleBtn = `<button class='btn ghost' data-act='open' style='padding:0;color:var(--accent)'>${p.title}</button>`;
        tr.innerHTML = `<td>${idx+1}</td><td>${titleBtn}</td><td>${p.author}</td><td>${fmtDate(p.createdAt)}</td><td>${canEdit?'<button class=\'btn\' data-act=\'edit\'>í¸ì§‘</button> <button class=\'btn danger\' data-act=\'del\'>ì‚­ì œ</button>':''}</td>`;
        tr.querySelector('[data-act=open]')?.addEventListener('click', ()=> openViewPost(p.id));
        tr.querySelector('[data-act=edit]')?.addEventListener('click', ()=> openEditPost(p.id));
        tr.querySelector('[data-act=del]')?.addEventListener('click', ()=> deletePost(p.id));
        boardTableBody.appendChild(tr);
      });
    }

    function openNewPost(){ editingPostId=null; postDlgTitle.textContent='ê¸€ì“°ê¸°'; postTitle.value=''; postBody.value=''; postDlg.showModal(); setTimeout(()=> postTitle.focus(), 50); }
    function openEditPost(id){ const p=posts.find(x=>x.id===id); if(!p) return; editingPostId=id; postDlgTitle.textContent='ê¸€ ìˆ˜ì •'; postTitle.value=p.title; postBody.value=p.body; postDlg.showModal(); setTimeout(()=> postTitle.focus(), 50); }
    function deletePost(id){
      const p = posts.find(x=>x.id===id); if(!p) return;
      if(!confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return; posts = posts.filter(x=>x.id!==id); write(LS_POSTS, posts); renderBoard(); addLog('post_deleted', {title:p.title, author:p.author});
    }

    postNewBtn.addEventListener('click', ()=>{ if(!session){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; } openNewPost(); });
    postForm.addEventListener('submit', (e)=>{ e.preventDefault(); if(!session){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; } const title=postTitle.value.trim(); const body=postBody.value.trim(); if(!title){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return;} if(!body){ alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } if(editingPostId){ posts = posts.map(p=> p.id===editingPostId ? { ...p, title, body, updatedAt: Date.now() } : p); addLog('post_edited', {id: editingPostId, title}); } else { posts.push({ id: uid(), title, body, author: session.name, createdAt: Date.now(), updatedAt: Date.now(), comments: [] }); addLog('post_added', {title}); } write(LS_POSTS, posts); postDlg.close(); renderBoard(); });
    [closePostDlg, cancelPostBtn].forEach(b=> b.addEventListener('click', ()=> postDlg.close()));

    function openViewPost(id){
      const p = posts.find(x=>x.id===id); if(!p) return; viewingPostId=id;
      postViewTitle.textContent = p.title; postViewBody.textContent = p.body; postMeta.textContent = `${p.author} Â· ${fmtDate(p.createdAt)}`;
      // viewer actions
      postViewActions.innerHTML='';
      if(session && (session.name==='admin' || session.name===p.author)){
        const eBtn=document.createElement('button'); eBtn.className='btn'; eBtn.textContent='í¸ì§‘'; eBtn.addEventListener('click', ()=>{ postViewDlg.close(); openEditPost(id); });
        const dBtn=document.createElement('button'); dBtn.className='btn danger'; dBtn.textContent='ì‚­ì œ'; dBtn.addEventListener('click', ()=>{ if(confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')){ deletePost(id); postViewDlg.close(); } });
        postViewActions.appendChild(eBtn); postViewActions.appendChild(dBtn);
      }
      renderComments();
      commentBody.value='';
      postViewDlg.showModal();
    }
    closePostViewDlg.addEventListener('click', ()=> postViewDlg.close());

    function renderComments(){
      commentsWrap.innerHTML='';
      const p = posts.find(x=>x.id===viewingPostId); if(!p) return;
      const items = (p.comments||[]).slice().sort((a,b)=> a.createdAt - b.createdAt);
      if(items.length===0){
        const empty = document.createElement('div'); empty.className='empty'; empty.textContent='ëŒ“ê¸€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.'; commentsWrap.appendChild(empty); return;
      }
      items.forEach(c=>{
        const div=document.createElement('div'); div.className='comment';
        const head=document.createElement('div'); head.className='commentHead';
        head.innerHTML = `<div class='muted'>${c.author} Â· ${fmtDate(c.createdAt)}</div>`;
        if(session && (session.name==='admin' || session.name===c.author)){
          const actions=document.createElement('div');
          const eb=document.createElement('button'); eb.className='btn'; eb.textContent='í¸ì§‘'; eb.addEventListener('click', ()=> editComment(c.id));
          const db=document.createElement('button'); db.className='btn danger'; db.textContent='ì‚­ì œ'; db.addEventListener('click', ()=> deleteComment(c.id));
          actions.appendChild(eb); actions.appendChild(db); head.appendChild(actions);
        }
        const body=document.createElement('div'); body.style.whiteSpace='pre-wrap'; body.style.marginTop='6px'; body.textContent=c.body;
        div.appendChild(head); div.appendChild(body);
        commentsWrap.appendChild(div);
      });
    }

    function addComment(){
      if(!session){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      const text = commentBody.value.trim(); if(!text){ alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      const p = posts.find(x=>x.id===viewingPostId); if(!p) return;
      p.comments = Array.isArray(p.comments) ? p.comments : [];
      p.comments.push({ id: uid(), body: text, author: session.name, createdAt: Date.now() });
      write(LS_POSTS, posts);
      commentBody.value='';
      renderComments();
    }
    function editComment(cid){
      const p = posts.find(x=>x.id===viewingPostId); if(!p) return;
      const c = (p.comments||[]).find(x=>x.id===cid); if(!c) return;
      const text = prompt('ëŒ“ê¸€ ìˆ˜ì •', c.body);
      if(text===null) return;
      c.body = text.trim();
      write(LS_POSTS, posts);
      renderComments();
    }
    function deleteComment(cid){
      const p = posts.find(x=>x.id===viewingPostId); if(!p) return;
      const c = (p.comments||[]).find(x=>x.id===cid); if(!c) return;
      if(!confirm('ì´ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
      p.comments = (p.comments||[]).filter(x=>x.id!==cid);
      write(LS_POSTS, posts);
      renderComments();
      addLog('comment_deleted', {postTitle:p.title, commentAuthor:c.author});
    }
    addCommentBtn.addEventListener('click', addComment);
    cancelCommentBtn.addEventListener('click', ()=> commentBody.value='');

    // ====== Admin: Approvals ======
    const signupTableBody = document.querySelector('#signupTable tbody');
    const signupEmpty = document.getElementById('signupEmpty');

    function renderApprovals(){
      signupTableBody.innerHTML='';
      if(!signups.length){ signupEmpty.style.display='block'; return; }
      signupEmpty.style.display='none';
      signups.slice().sort((a,b)=> a.createdAt-b.createdAt).forEach(s=>{
        const tr=document.createElement('tr');
        const part = s.part==='ì§ì ‘ì…ë ¥' ? (s.partCustom||'ì§ì ‘ì…ë ¥') : s.part;
        tr.innerHTML = `<td>${s.name}</td><td>${s.dept||''}</td><td>${part}</td><td>${fmtDate(s.createdAt)}</td><td><button class='btn' data-act='ok'>ìŠ¹ì¸</button> <button class='btn danger' data-act='no'>ê±°ì ˆ</button></td>`;
        tr.querySelector('[data-act=ok]').addEventListener('click', async ()=>{
          if(users.some(u=> u.name===s.name)) { alert('ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ ê³„ì •ì´ ì¡´ì¬í•©ë‹ˆë‹¤.'); return; }
          users.push({ id: uid(), name:s.name, hash:s.hash, dept:s.dept||'', part:s.part, partCustom:s.partCustom||'', createdAt: Date.now() });
          write(LS_USERS, users);
          signups = signups.filter(x=> x!==s); write(LS_SIGNUPS, signups);
          addLog('signup_approved', {name:s.name, dept:s.dept, part:(s.part==='ì§ì ‘ì…ë ¥'?(s.partCustom||s.part):s.part)});
          renderApprovals(); renderUsers();
        });
        tr.querySelector('[data-act=no]')?.addEventListener('click', ()=>{ signups = signups.filter(x=> x!==s); write(LS_SIGNUPS, signups); addLog('signup_rejected', {name:s.name}); renderApprovals(); });
        signupTableBody.appendChild(tr);
      });
    }

    // ====== Admin: Users (add/edit/delete/reset) ======
    const usersTableBody = document.querySelector('#usersTable tbody');
    const usersEmpty = document.getElementById('usersEmpty');
    const userAddBtn = document.getElementById('userAddBtn');

    const userDlg = document.getElementById('userDlg');
    const userForm = document.getElementById('userForm');
    const userDlgTitle = document.getElementById('userDlgTitle');
    const closeUserDlg = document.getElementById('closeUserDlg');
    const cancelUserBtn = document.getElementById('cancelUserBtn');
    const udName = document.getElementById('udName');
    const udPw = document.getElementById('udPw');
    const udDept = document.getElementById('udDept');
    const udPart = document.getElementById('udPart');
    const udPartCustomWrap = document.getElementById('udPartCustomWrap');
    const udPartCustom = document.getElementById('udPartCustom');

    let editingUserId = null; // null => add, else edit

    function renderUsers(){
      usersTableBody.innerHTML='';
      const data = users.slice().sort((a,b)=> collator.compare(a.name,b.name));
      if(data.length===0){ usersEmpty.style.display='block'; return; }
      usersEmpty.style.display='none';
      data.forEach(u=>{
        const part = u.part==='ì§ì ‘ì…ë ¥' ? (u.partCustom||'ì§ì ‘ì…ë ¥') : u.part;
        const tr=document.createElement('tr');
        const isAdmin = (u.name==='admin');
        const mgmt = isAdmin? '<span class="muted">(ê´€ë¦¬ì)</span>' : `<button class='btn' data-act='edit'>ìˆ˜ì •</button> <button class='btn' data-act='reset'>ë¹„ë²ˆ ì´ˆê¸°í™”</button> <button class='btn danger' data-act='del'>ì‚­ì œ</button>`;
        tr.innerHTML = `<td>${u.name}</td><td>${u.dept||''}</td><td>${part||''}</td><td>${fmtDate(u.createdAt)}</td><td>${mgmt}</td>`;
        if(!isAdmin){
          tr.querySelector('[data-act=edit]')?.addEventListener('click', ()=> openEditUser(u.id));
          tr.querySelector('[data-act=reset]')?.addEventListener('click', ()=> resetPassword(u.id));
          tr.querySelector('[data-act=del]')?.addEventListener('click', ()=> deleteUser(u.id));
        }
        usersTableBody.appendChild(tr);
      });
    }

    function openAddUser(){
      editingUserId = null;
      userDlgTitle.textContent='ì‚¬ìš©ì ì¶”ê°€';
      udName.value=''; udPw.value=''; udDept.value=''; udPart.value='ì¼ë ‰ê¸°íƒ€'; udPartCustom.value=''; udPartCustomWrap.style.display='none';
      document.getElementById('udPwHint').textContent='(ìƒˆ ì‚¬ìš©ì: í•„ìˆ˜ / ìˆ˜ì • ì‹œ ë¹„ì›Œë‘ë©´ ìœ ì§€)';
      userDlg.showModal();
    }
    function openEditUser(id){
      const u = users.find(x=>x.id===id); if(!u) return;
      editingUserId = id;
      userDlgTitle.textContent='ì‚¬ìš©ì ìˆ˜ì •';
      udName.value=u.name; udPw.value=''; udDept.value=u.dept||''; udPart.value=u.part||'ì¼ë ‰ê¸°íƒ€'; udPartCustom.value=u.partCustom||''; udPartCustomWrap.style.display = (udPart.value==='ì§ì ‘ì…ë ¥') ? 'block' : 'none';
      document.getElementById('udPwHint').textContent='(ë¹„ì›Œë‘ë©´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì—†ìŒ)';
      userDlg.showModal();
    }

    function resetPassword(uidx){
      const u = users.find(x=>x.id===uidx); if(!u) return;
      if(u.name==='admin'){ alert('ê´€ë¦¬ì ê³„ì • ë¹„ë°€ë²ˆí˜¸ëŠ” ì´ í™”ë©´ì—ì„œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬: 1111)'); return; }
      const pw = prompt(`ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‚¬ìš©ì: ${u.name})`);
      if(pw===null || pw==='') return;
      hashHex(pw).then(h=>{ u.hash = h; write(LS_USERS, users); addLog('password_reset', {name:u.name}); alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); });
    }
    function deleteUser(uidx){
      const u = users.find(x=>x.id===uidx); if(!u) return;
      if(u.name==='admin'){ alert('ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if(!confirm(`${u.name} ê³„ì •ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      users = users.filter(x=> x.id!==uidx); write(LS_USERS, users); renderUsers(); addLog('user_deleted', {name:u.name});
      if(session && session.name===u.name){ alert('ì‚­ì œëœ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆì–´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.'); session=null; localStorage.removeItem(LS_SESSION); location.reload(); }
    }

    userAddBtn.addEventListener('click', openAddUser);
    udPart.addEventListener('change', ()=>{ udPartCustomWrap.style.display = (udPart.value==='ì§ì ‘ì…ë ¥') ? 'block' : 'none'; });
    userForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name=udName.value.trim(); const pw=udPw.value; const dept=udDept.value.trim(); const part=udPart.value; const partCustom=udPartCustom.value.trim();
      if(!name){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(part==='ì§ì ‘ì…ë ¥' && !partCustom){ alert('ë‹´ë‹¹ íŒŒíŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(editingUserId){
        const u = users.find(x=>x.id===editingUserId); if(!u) return;
        if(name!==u.name && users.some(x=>x.name===name)){ alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
        const oldName = u.name;
        u.name = name; u.dept = dept; u.part = part; u.partCustom = partCustom;
        if(pw){ u.hash = await hashHex(pw); }
        write(LS_USERS, users); renderUsers(); userDlg.close(); addLog('user_edited', {oldName, newName:name});
        if(session && session.name===oldName){ session.name = name; write(LS_SESSION, session); renderUserBar(); }
      } else {
        if(!pw){ alert('ìƒˆ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        if(users.some(u=> u.name===name)) { alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
        const hash = await hashHex(pw);
        users.push({ id: uid(), name, hash, dept, part, partCustom, createdAt: Date.now() }); write(LS_USERS, users);
        userDlg.close(); renderUsers(); addLog('user_added', {name});
      }
    });
    [closeUserDlg, cancelUserBtn].forEach(b=> b.addEventListener('click', ()=> userDlg.close()));

    // ====== Profile (self-edit) ======
    const profileDlg = document.getElementById('profileDlg');
    const profileForm = document.getElementById('profileForm');
    const closeProfileDlg = document.getElementById('closeProfileDlg');
    const pfName = document.getElementById('pfName');
    const pfDept = document.getElementById('pfDept');
    const pfPart = document.getElementById('pfPart');
    const pfPartCustomWrap = document.getElementById('pfPartCustomWrap');
    const pfPartCustom = document.getElementById('pfPartCustom');
    const pfCurPw = document.getElementById('pfCurPw');
    const pfNewPw = document.getElementById('pfNewPw');
    const pfNewPw2 = document.getElementById('pfNewPw2');

    function openProfile(){
      if(!session){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      const u = users.find(x=> x.name===session.name);
      if(!u){ alert('ì„¸ì…˜ ì˜¤ë¥˜: ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const isAdmin = (u.name==='admin');
      pfName.value = u.name;
      pfDept.value = u.dept||'';
      pfPart.value = u.part||'ì¼ë ‰ê¸°íƒ€';
      pfPartCustom.value = u.partCustom||'';
      pfPartCustomWrap.style.display = (pfPart.value==='ì§ì ‘ì…ë ¥') ? 'block':'none';
      pfCurPw.value=''; pfNewPw.value=''; pfNewPw2.value='';
      pfName.disabled = isAdmin;
      pfCurPw.disabled = isAdmin; pfNewPw.disabled = isAdmin; pfNewPw2.disabled = isAdmin;
      document.getElementById('pfPwHint').textContent = isAdmin ? '(ê´€ë¦¬ìëŠ” ì—¬ê¸°ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’: 1111)' : '(ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)';
      profileDlg.showModal();
      setTimeout(()=> pfName.focus(), 50);
    }

    pfPart.addEventListener('change', ()=>{ pfPartCustomWrap.style.display = (pfPart.value==='ì§ì ‘ì…ë ¥') ? 'block' : 'none'; });
    profileForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!session) return;
      const u = users.find(x=> x.name===session.name); if(!u) return;
      const isAdmin = (u.name==='admin');
      const name = pfName.value.trim();
      const dept = pfDept.value.trim();
      const part = pfPart.value;
      const partCustom = pfPartCustom.value.trim();
      if(part==='ì§ì ‘ì…ë ¥' && !partCustom){ alert('ë‹´ë‹¹ íŒŒíŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(!isAdmin && name!==u.name && users.some(x=> x.name===name)){ alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
      const oldName = u.name;
      if(!isAdmin) u.name = name;
      u.dept = dept; u.part = part; u.partCustom = partCustom;

      const cur = pfCurPw.value; const n1 = pfNewPw.value; const n2 = pfNewPw2.value;
      if(n1 || n2 || cur){
        if(isAdmin){ alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ëŠ” ì´ í™”ë©´ì—ì„œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
        else {
          if(!cur){ alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
          const curHash = await hashHex(cur);
          if(curHash !== u.hash){ alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
          if(!n1){ alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
          if(n1 !== n2){ alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
          u.hash = await hashHex(n1);
          addLog('self_password_changed', {name: u.name});
        }
      }
      write(LS_USERS, users);
      if(session && session.name===oldName && !isAdmin){ session.name = u.name; write(LS_SESSION, session); renderUserBar(); }
      addLog('self_edited', {oldName, newName: u.name});
      profileDlg.close();
      if(document.querySelector('#tab-admin').style.display!=='none'){ renderUsers(); }
    });
    [closeProfileDlg].forEach(b=> b.addEventListener('click', ()=> profileDlg.close()));

    // ====== Admin Logs ======
    const logsTableBody = document.querySelector('#logsTable tbody');
    const logsEmpty = document.getElementById('logsEmpty');
    const logsClearBtn = document.getElementById('logsClearBtn');
    const logsExportBtn = document.getElementById('logsExportBtn');

    function friendly(action, meta){
      switch(action){
        case 'bootstrap_admin': return 'ê´€ë¦¬ì ê³„ì • ì´ˆê¸° ìƒì„±';
        case 'signup_approved': return `ê°€ì… ìŠ¹ì¸: ${meta.name}`;
        case 'signup_rejected': return `ê°€ì… ê±°ì ˆ: ${meta.name}`;
        case 'user_added': return `ì‚¬ìš©ì ì¶”ê°€: ${meta.name}`;
        case 'user_edited': return `ì‚¬ìš©ì ìˆ˜ì •: ${meta.oldName} â†’ ${meta.newName}`;
        case 'user_deleted': return `ì‚¬ìš©ì ì‚­ì œ: ${meta.name}`;
        case 'password_reset': return `ë¹„ë²ˆ ì´ˆê¸°í™”: ${meta.name}`;
        case 'self_edited': return `ë‚´ ì •ë³´ ìˆ˜ì •: ${meta.oldName} â†’ ${meta.newName}`;
        case 'self_password_changed': return `ë‚´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½`;
        case 'song_added': return `ê³¡ ì¶”ê°€: ${meta.title} / ${meta.artist}`;
        case 'song_edited': return `ê³¡ ìˆ˜ì •: ${meta.title} / ${meta.artist}`;
        case 'song_deleted': return `ê³¡ ì‚­ì œ: ${meta.title} / ${meta.artist}`;
        case 'post_added': return `ê¸€ ë“±ë¡: ${meta.title}`;
        case 'post_edited': return `ê¸€ ìˆ˜ì •: ${meta.title}`;
        case 'post_deleted': return `ê¸€ ì‚­ì œ: ${meta.title}`;
        case 'comment_deleted': return `ëŒ“ê¸€ ì‚­ì œ: ${meta.postTitle}`;
        default: return action;
      }
    }`;
        case 'signup_rejected': return `ê°€ì… ê±°ì ˆ: ${meta.name}`;
        case 'user_added': return `ì‚¬ìš©ì ì¶”ê°€: ${meta.name}`;
        case 'user_edited': return `ì‚¬ìš©ì ìˆ˜ì •: ${meta.oldName} â†’ ${meta.newName}`;
        case 'user_deleted': return `ì‚¬ìš©ì ì‚­ì œ: ${meta.name}`;
        case 'password_reset': return `ë¹„ë²ˆ ì´ˆê¸°í™”: ${meta.name}`;
        case 'song_added': return `ê³¡ ì¶”ê°€: ${meta.title} / ${meta.artist}`;
        case 'song_edited': return `ê³¡ ìˆ˜ì •: ${meta.title} / ${meta.artist}`;
        case 'song_deleted': return `ê³¡ ì‚­ì œ: ${meta.title} / ${meta.artist}`;
        case 'post_added': return `ê¸€ ë“±ë¡: ${meta.title}`;
        case 'post_edited': return `ê¸€ ìˆ˜ì •: ${meta.title}`;
        case 'post_deleted': return `ê¸€ ì‚­ì œ: ${meta.title}`;
        case 'comment_deleted': return `ëŒ“ê¸€ ì‚­ì œ: ${meta.postTitle}`;
        default: return action;
      }
    }

    function renderLogs(){
      logsTableBody.innerHTML='';
      const data = logs.slice(0,300); // show latest 300
      if(data.length===0){ logsEmpty.style.display='block'; return; }
      logsEmpty.style.display='none';
      data.forEach(l=>{
        const tr=document.createElement('tr');
        const detail = JSON.stringify(l.meta||{}, null, 0);
        tr.innerHTML = `<td>${fmtDate(l.ts)}</td><td>${l.actor||'-'}</td><td>${friendly(l.action,l.meta)}</td><td><code style="white-space:pre-wrap">${detail}</code></td>`;
        logsTableBody.appendChild(tr);
      });
    }

    logsClearBtn.addEventListener('click', ()=>{ if(!confirm('ëª¨ë“  ë¡œê·¸ë¥¼ ë¹„ìš¸ê¹Œìš”?')) return; logs=[]; write(LS_LOGS, logs); renderLogs(); });
    logsExportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(logs,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='kish_admin_logs.json'; a.click(); URL.revokeObjectURL(url);
    });

    // ====== Tabs ======
    function showTab(id){
      document.querySelectorAll('#appScreen section[id^=tab-]').forEach(sec=> sec.style.display='none');
      document.getElementById('tab-'+id).style.display='block';
      document.querySelectorAll('#mainTabs .tab').forEach(t=> t.classList.remove('active'));
      document.querySelector(`#mainTabs .tab[data-tab="${id}"]`).classList.add('active');
      if(id==='playlist'){ renderSongs(); }
      if(id==='board'){ renderBoard(); }
      if(id==='admin'){ renderApprovals(); renderUsers(); renderLogs(); }
    }
    mainTabs.addEventListener('click', (e)=>{ const b=e.target.closest('.tab'); if(!b) return; const id=b.dataset.tab; showTab(id); });

    // ====== AUTH Handlers ======
    tabLogin.addEventListener('click', ()=>{ tabLogin.classList.add('active'); tabSignup.classList.remove('active'); loginPane.style.display='block'; signupPane.style.display='none'; });
    tabSignup.addEventListener('click', ()=>{ tabSignup.classList.add('active'); tabLogin.classList.remove('active'); loginPane.style.display='none'; signupPane.style.display='block'; });

    suPart.addEventListener('change', ()=>{ suPartCustomWrap.style.display = (suPart.value==='ì§ì ‘ì…ë ¥') ? 'block' : 'none'; });

    signupBtn.addEventListener('click', async ()=>{
      const name=suName.value.trim(); const pw=suPw.value; const pw2=suPw2.value; const dept=suDept.value.trim(); const part=suPart.value; const partCustom=suPartCustom.value.trim();
      if(!name||!pw||!pw2){ alert('ì´ë¦„/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(pw!==pw2){ alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      if(part==='ì§ì ‘ì…ë ¥' && !partCustom){ alert('ë‹´ë‹¹ íŒŒíŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(users.some(u=> u.name===name) || signups.some(s=> s.name===name)){ alert('ì´ë¯¸ ì‹ ì²­ ë˜ëŠ” ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
      const hash = await hashHex(pw);
      signups.push({ id: uid(), name, hash, dept, part, partCustom, createdAt: Date.now() }); write(LS_SIGNUPS, signups);
      alert('íšŒì›ê°€ì… ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      suName.value=''; suPw.value=''; suPw2.value=''; suDept.value=''; suPart.value='ì¼ë ‰ê¸°íƒ€'; suPartCustom.value=''; suPartCustomWrap.style.display='none';
    });

    loginBtn.addEventListener('click', async ()=>{
      const name=loginName.value.trim();

    // Quick init/reset & Enter-to-login
    const initBtn = document.getElementById('initBtn');
    if(initBtn){
      initBtn.addEventListener('click', ()=>{
        if(!confirm('ë¡œì»¬ ì €ì¥ì†Œì˜ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? (ê³¡/ì‚¬ìš©ì/ê²Œì‹œê¸€/ë¡œê·¸/ì„¸ì…˜)')) return;
        try{
          [LS_SONGS,LS_USERS,LS_SIGNUPS,LS_POSTS,LS_SESSION,LS_LOGS].forEach(k=> localStorage.removeItem(k));
        }catch(e){}
        alert('ì´ˆê¸°í™” ì™„ë£Œ. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
        location.reload();
      });
    }
    [loginName, loginPw].forEach(el=> el && el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ loginBtn.click(); }})); const pw=loginPw.value; if(!name||!pw){ alert('ì´ë¦„/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(name==='admin'){
        if(pw==='1111'){ session={name}; write(LS_SESSION, session); enterApp(); }
        else alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      const user = users.find(u=> u.name===name);
      if(!user){
        if(signups.some(s=> s.name===name)) alert('ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.'); else alert('ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì•„ë‹™ë‹ˆë‹¤. íšŒì›ê°€ì… í›„ ìŠ¹ì¸ì„ ë°›ìœ¼ì„¸ìš”.');
        return;
      }
      const hash = await hashHex(pw);
      if(hash!==user.hash){ alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      session={name}; write(LS_SESSION, session); enterApp();
    });

    function enterApp(){
      authScreen.style.display='none'; appScreen.style.display='block';
      renderUserBar();
      adminTab.style.display = (session && session.name==='admin') ? 'inline-flex' : 'none';
      showTab('playlist');
    }

    // Auto-login if session exists
    if(session){ enterApp(); }
  </script>
</body>
</html>
